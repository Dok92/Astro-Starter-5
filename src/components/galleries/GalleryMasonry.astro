---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface GalleryImage {
  src: ImageMetadata;
  alt: string;
}

interface Props {
  images: GalleryImage[];
  title: string;
  description: string;
  id?: string;
}

const { images, title, description, id = 'galerija' } = Astro.props;
---

<section class='gallery padding-horizontal padding-top' id={id}>
  <div class='gallery-headline'>
    <h2 class='gallery-title'>{title}</h2>
    <p class='gallery-desc'>{description}</p>
  </div>

  <div class='gallery-masonry'>
    {
      images.map((img) => (
        <div class='gallery-item'>
          <Image
            src={img.src}
            alt={img.alt}
            widths={[400, 600]}
            sizes='(max-width: 768px) 45vw, 350px'
            loading='lazy'
          />
        </div>
      ))
    }
  </div>
</section>

<style>
  .gallery {
    display: flex;
    flex-direction: column;
    gap: var(--space-400);
  }

  .gallery-headline {
    max-width: 600px;
    margin-bottom: var(--space-400);
  }

  .gallery-title {
    margin-bottom: var(--space-300);
  }

  .gallery-desc {
    margin: 0;
  }

  .gallery-masonry {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    grid-auto-rows: 5px;
    gap: 10px;
    width: 100%;
  }

  .gallery-item {
    grid-row-end: span 20;
    width: 100%;
    overflow: hidden;
  }

  .gallery-item img {
    width: 100%;
    height: auto;
    display: block;
  }

  @media (min-width: 768px) {
    .gallery-masonry {
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    }
  }
</style>

<script>
  function resizeMasonryItem(grid: Element, item: Element) {
    const rowHeight = parseInt(getComputedStyle(grid).getPropertyValue('grid-auto-rows'));
    const rowGap = parseInt(getComputedStyle(grid).getPropertyValue('gap'));
    const img = item.querySelector('img');
    if (!img) return;

    const rowSpan = Math.ceil((img.getBoundingClientRect().height + rowGap) / (rowHeight + rowGap));
    (item as HTMLElement).style.gridRowEnd = `span ${rowSpan}`;
  }

  function resizeGrid(grid: Element) {
    grid.querySelectorAll('.gallery-item').forEach((item) => resizeMasonryItem(grid, item));
  }

  function initMasonry() {
    const grids = document.querySelectorAll('.gallery-masonry');
    grids.forEach(resizeGrid);
  }

  document.querySelectorAll('.gallery-masonry img').forEach((img) => {
    img.addEventListener('load', () => {
      const grid = img.closest('.gallery-masonry');
      if (grid) resizeGrid(grid);
    });
  });

  window.addEventListener('resize', initMasonry);
  window.addEventListener('load', initMasonry);
</script>
